---
- hosts: all
  become: true
  vars:
    workspace: "{{ lookup('env','WORKSPACE') }}"
  vars_files: ["secrets/{{site_id}}","secrets/ssh_passwords"]
  tasks:
  - name: Create configuration.php
    template:
      src: "{{ config_src }}"
      dest: "{{ doc_root }}/configuration.php"
      owner: "{{ server_runs_as }}"
      group: "{{ server_runs_as_group }}"

  - name: Create .htversion file
    file:
      path: "{{ doc_root }}/.htversion"
      state: touch
      owner: "{{ server_runs_as }}"
      group: "{{ server_runs_as_group }}"

  - name: Write commit number .htversion to file
    shell: echo "{{ lookup('env','BUILD_NUMBER') }}" > {{ doc_root }}/.htversion

  - name: "Delete folders"
    file: path="{{ doc_root }}/{{ item }}" state=absent force=yes owner="{{server_runs_as}}" group="{{server_runs_as_group}}"
    with_items:
      - "cache"
      - "tmp"
      - "logs"
      - "administrator"
      - "components"
      - "modules"
      - "plugins"
      - "templates"
      - "language"
      - "libraries"
      - "includes"
      - "index.php"

  - name: "Create empty dirs"
    file: path="{{ doc_root }}/{{ item }}" state=directory force=yes owner="{{server_runs_as}}" group="{{server_runs_as_group}}"
    with_items:
      - "cache"
      - "tmp"
      - "logs"
      - "administrator"
      - "administrator/cache"

  - name: create empty index.html files
    file: path="{{ doc_root }}/{{ item }}/index.html" state=touch owner="{{server_runs_as}}" group="{{server_runs_as_group}}"
    with_items:
      - "cache"
      - "tmp"
      - "logs"
      - "administrator/cache"

  - name: Unarchive artifact on remote server
    unarchive:
      src: "{{ workspace | default('') }}/{{ artifact_filename }}"
      dest: "{{ doc_root }}"
      copy: yes
      owner: "{{ server_runs_as }}"
      group: "{{ server_runs_as_group }}"

  - name: Create all wget cronjobs
    become: false
    tags: cron
    cron:
      name: "{{item.name}}"
      minute: "{{item.minute}}"
      hour: "{{item.hour}}"
      job: "/usr/bin/wget --no-check-certificate -qO- '{{item.url}}' &> /dev/null"
    with_items :
    - {
      name: "Create Invitex cron",
      url: "https://{{ deploy_env_domain }}/index.php?option=com_invitex&tmpl=component&task=mailto&pkey=abcd1234",
      minute: "*/10",
      hour: "*"
    }
    - {
      name: "Create Easy social Profile",
      url: "https://{{ deploy_env_domain }}/index.php?option=com_advsearch&task=cronjob&pkey=abcd1234&type=easysocial",
      minute: "*/5",
      hour: "*"
    }
    - {
      name: "RSticket cron",
      url: "https://{{ deploy_env_domain }}/index.php?option=com_rsticketspro&task=cron",
      minute: "*/10",
      hour: "*"
    }
    - {
      name: "HWD media share cron",
      url: "https://{{ deploy_env_domain }}/index.php?option=com_hwdmediashare&task=maintenance.cdn&format=raw&token=6wv2v2j8ka",
      minute: "*",
      hour: "*/4"
    }

  - name: Create cli cronjobs for akeeba back-up
    become: false
    tags: cron
    when: (deploy_env == "prod-learning")
    cron:
      name: "{{item.name}}"
      minute: "{{item.minute}}"
      hour: "{{item.hour}}"
      job: "/usr/bin/php5.6 {{item.url}} &> /dev/null"
    with_items :
    - {
      name: "Create Akeeba Backup of Learning Full Site",
      url: "{{sites_container}}/{{deploy_env_domain}}/public/cli/akeeba-backup.php --profile=3",
      minute: "30",
      hour: "4"
    }
    - {
      name: "Create Akeeba Backup for Learning DB",
      url: "{{sites_container}}/{{deploy_env_domain}}/public/cli/akeeba-backup.php --profile=2",
      minute: "30",
      hour: "7,15,23"
    }
